+++
date = "2013-02-21T16:06:57+09:00"
draft = false
title = "ChefでRoleやRecipeを実行するとき渡すべき必須のattributesをチェックする"
categories = ["chef"]
+++

例えばlvsを構築するときに、その下にぶら下がるreal serverたちのIPアドレスとかって、chef-client実行するときに-jオプション使ってjsonでattributes渡して欲しいわけですが、実際に実行する前に必須のものがなければ弾きたい、と思って色々ためした結果

Roleならjsonに、Recipeならattributes/default.rbに、__required__とかそういう感じの名前でattributesを作って、そこに配列で指定必須のattributesを並べて書いておく。

[sourcecode language="javascript"]
{
  &quot;name&quot;: &quot;nannchara-kannchara&quot;,
  &quot;default_attributes&quot;: {
  },
  &quot;json_class&quot;: &quot;Chef::Role&quot;,
  &quot;env_run_lists&quot;: {
  },
  &quot;run_list&quot;: [
    &quot;recipe[foo]&quot;,
    &quot;recipe[bar::baz]&quot;
  ],
  &quot;description&quot;: &quot;hogeraccho&quot;,
  &quot;chef_type&quot;: &quot;role&quot;,
  &quot;override_attributes&quot;: {
      &quot;__required__&quot;: [
        &quot;test&quot;,
        &quot;test1&quot;,
        &quot;test2&quot;
      ]
  }
}
```

んで knife role from file nannchara-kannchara.json すると、knife search コマンドで取り出せるようになるので、あとは適当に整形すれば一覧として取り出せる

[sourcecode language="bash"]
$ knife search role -F json -q &quot;name:nannchara-kannchara AND __required__:*&quot; | tr -d '\n' | tr -d ' ' | grep -oE &quot;required[^]]+&quot; | awk -F[ '{print $2}' | tr ',' '\n' | tr -d '&quot;'
test
test1
test2
```

無理やり感があるがまぁ使えるのでよし。
