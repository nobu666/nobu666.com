+++
date = "2011-01-20T16:11:20+09:00"
draft = false
title = "JavaScriptでいい感じにURLとかScreenNameとかをリンクにする正規表現"
categories = ["diary"]
+++

URLに@が入ってたりすると、ScreenNameのリンクとごっちゃになって割と対応に手間取ったのでメモとして。日本語のハッシュタグなんか最近見かけないからどうでもいいような気もするけど、まぁ一応対応。

[sourcecode language="javascript" padlinenumbers="2"]
var text=&quot;@xyz aaa http://aaa.com:8080/@abc#asdf http://日本語.jp/?abc&amp;amp;asdf http://example.jp/a.b.c@d.e bbb @ccc/@ddd/＠eee #hash #日本語だめ #日本語おｋ_ http://a.com/日本語&quot;;
text.replace(/(https?:\/\/(?:[^!&quot;#$%&amp;amp;'\(\)*\+,-\./:;&amp;lt;=&amp;gt;\?@\[\\\]^_`\{\|\}~\s][\.-](?=[^!&quot;#$%&amp;amp;'\(\)*\+,-\./:;&amp;lt;=&amp;gt;\?@\[\\\]^_`\{\|\}~\s])|[^!&quot;#$%&amp;amp;'\(\)*\+,-\./:;&amp;lt;=&amp;gt;\?@\[\\\]^_`\{\|\}~\s]){1,}\.[a-z]{2,}(?::[0-9]+)?(?:\/(?:[\x21-\x7e]+)?)?)|(?:[@＠])([a-z0-9_]{1,20})|(?:#|\uFF03)([^\s\/ \x21-\x2f\x3a-\x40\x5b-\x5e\x60\x7b-\x7e]+[a-z0-9_])/mgi, function(){
 if(arguments[1]!==&quot;&quot;){
  return &quot;&amp;lt;a class='url' href='&quot;+arguments[1]+&quot;'&amp;gt;&quot;+arguments[1]+&quot;&amp;lt;/a&amp;gt;&quot;;
 }else if(arguments[2]==&quot;&quot; &amp;amp;&amp;amp; arguments[3]==&quot;&quot;){
  return arguments[1];
 }
 if(arguments[2]!==&quot;&quot;){
  return &quot;&amp;lt;a class='screen_name' href='http://twitter.com/&quot;+arguments[2]+&quot;'&amp;gt;@&quot;+arguments[2]+&quot;&amp;lt;/a&amp;gt;&quot;;
 }else if (arguments[3]==&quot;&quot;){
  return arguments[2];
 }
 if (arguments[3]!==&quot;&quot;){
  return &quot;&amp;lt;a class='hashtag' href='http://search.twitter.com/search?q=%23&quot;+arguments[3]+&quot;'&amp;gt;#&quot;+arguments[3]+&quot;&amp;lt;/a&amp;gt;&quot;;
 } else {
  return arguments[3];
 }
}
)
```

実行すると

[sourcecode padlinenumbers="2" language="laguage="]
&quot;&amp;lt;a class='screen_name' href='http://twitter.com/xyz'&amp;gt;@xyz&amp;lt;/a&amp;gt; aaa &amp;lt;a class='url' href='http://aaa.com:8080/@abc#asdf'&amp;gt;http://aaa.com:8080/@abc#asdf&amp;lt;/a&amp;gt; &amp;lt;a class='url' href='http://日本語.jp/?abc&amp;amp;asdf'&amp;gt;http://日本語.jp/?abc&amp;amp;asdf&amp;lt;/a&amp;gt; &amp;lt;a class='url' href='http://example.jp/a.b.c@d.e'&amp;gt;http://example.jp/a.b.c@d.e&amp;lt;/a&amp;gt; bbb &amp;lt;a class='screen_name' href='http://twitter.com/ccc'&amp;gt;@ccc&amp;lt;/a&amp;gt;/&amp;lt;a class='screen_name' href='http://twitter.com/ddd'&amp;gt;@ddd&amp;lt;/a&amp;gt;/&amp;lt;a class='screen_name' href='http://twitter.com/eee'&amp;gt;@eee&amp;lt;/a&amp;gt; &amp;lt;a class='hashtag' href='http://search.twitter.com/search?q=%23hash'&amp;gt;#hash&amp;lt;/a&amp;gt; #日本語だめ &amp;lt;a class='hashtag' href='http://search.twitter.com/search?q=%23日本語おｋ_'&amp;gt;#日本語おｋ_&amp;lt;/a&amp;gt; &amp;lt;a class='url' href='http://a.com/'&amp;gt;http://a.com/&amp;lt;/a&amp;gt;日本語&quot;
```

という文字列になり、以下のようにほぼ思ったとおりのリンクになる

<a class='screen_name' href='http://twitter.com/xyz'>@xyz</a> aaa <a class='url' href='http://aaa.com:8080/@abc#asdf'>http://aaa.com:8080/@abc#asdf</a> <a class='url' href='http://日本語.jp/?abc&asdf'>http://日本語.jp/?abc&asdf</a> <a class='url' href='http://example.jp/a.b.c@d.e'>http://example.jp/a.b.c@d.e</a> bbb <a class='screen_name' href='http://twitter.com/ccc'>@ccc</a>/<a class='screen_name' href='http://twitter.com/ddd'>@ddd</a>/<a class='screen_name' href='http://twitter.com/eee'>@eee</a> <a class='hashtag' href='http://search.twitter.com/search?q=%23hash'>#hash</a> #日本語だめ <a class='hashtag' href='http://search.twitter.com/search?q=%23日本語おｋ_'>#日本語おｋ_</a> <a class='url' href='http://a.com/'>http://a.com/</a>日本語

ドメインじゃなくてPATH部分に日本語が含まれる、WikipediaのURLみたいなのには対応してない。やりゃできるけど、TwitterでURLを投げるときに、URLの後ろにスペースいれないで日本語を続けて入れる人も割といそうなので…とりあえずこれでいいかな、とか。

なんかもっと美しく簡単にできそうな気もするんだけど…誰か添削してください。
