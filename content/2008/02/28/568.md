+++
date = "2008-02-28T16:45:05+09:00"
draft = false
title = "wordpressのformatterがキモいタグを生成するので、どうにかする - v2.3.3の場合"
categories = ["memo"]
+++

前回の<a href="http://nobu666.com/2008/02/22/562.html">wordpressのformatterがキモいタグを生成するので、どうにかする</a>はME2.2.3以外でpatchすると、管理画面で激しくwarningが出てエライことになる。ので、v2.3.3用のpatch。

[sourcecode lang="diff"]
--- www/wp-includes/formatting.php.orig Thu Feb 28 16:37:29 2008
+++ www/wp-includes/formatting.php      Thu Feb 28 16:39:27 2008
@@ -63,7 +63,7 @@
        $pee = $pee . &quot;\n&quot;; // just to make things a little easier, pad the end
        $pee = preg_replace('|&lt;br /&gt;\s*&lt;br /&gt;|', &quot;\n\n&quot;, $pee);
        // Space things out a little
-        $allblocks = '(?:table|thead|tfoot|caption|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|form|map|area|blockquote|address|math|style|input|p|h[1-6]|hr)';
+       $allblocks = '(?:code|table|thead|tfoot|caption|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|form|map|area|blockquote|address|math|style|input|p|h[1-6]|hr)';
        $pee = preg_replace('!(&lt;' . $allblocks . '[^&gt;]*&gt;)!', &quot;\n$1&quot;, $pee);
        $pee = preg_replace('!(&lt;/' . $allblocks . '&gt;)!', &quot;$1\n\n&quot;, $pee);
        $pee = str_replace(array(&quot;\r\n&quot;, &quot;\r&quot;), &quot;\n&quot;, $pee); // cross-platform newlines
@@ -88,6 +88,10 @@
        if (strpos($pee, '&lt;pre') !== false)
                $pee = preg_replace_callback('!(&lt;pre.*?&gt;)(.*?)&lt;/pre&gt;!is', 'clean_pre', $pee );
        $pee = preg_replace( &quot;|\n&lt;/p&gt;$|&quot;, '&lt;/p&gt;', $pee );
+        $pee = preg_replace('| {4}|', str_repeat(' ',4), $pee);
+        $pee = str_replace('\\', '\\\\', $pee);
+        $pee = preg_replace('|&lt;code&gt;.*?&lt;/code&gt;|se', &quot;str_replace(array('&lt;p&gt;', '&lt;/p&gt;'), array('', '&lt;br /&gt;&lt;br /&gt;'), '$0')&quot;, $pee);
+        $pee = StripSlashes($pee);

        return $pee;
 }
```
