+++
date = "2008-02-22T18:36:22+09:00"
draft = false
title = "wordpressのformatterがキモいタグを生成するので、どうにかする - ME2.2.3の場合"
categories = ["memo"]
+++

&lt;p&gt;&lt;/code&gt;&lt;/p&gt;とかいう謎タグが生成されて激しく気持ち悪いので、phpに手を入れる。<a href="http://spring.sakurasaita.net/wordpress/25.html">As You Like It ? Blog Archive ? WordPressのエディタとの付き合い方</a>を参照して、その通りに書き換えるだけ。patchにしとく。

[sourcecode lang="diff"]
--- formatting.php.org  Fri Feb 22 18:23:52 2008
+++ formatting.php      Fri Feb 22 18:21:16 2008
@@ -55,7 +55,7 @@
        $pee = $pee . &quot;\n&quot;; // just to make things a little easier, pad the end
        $pee = preg_replace('|&lt;br /&gt;\s*&lt;br /&gt;|', &quot;\n\n&quot;, $pee);
        // Space things out a little
-       $allblocks = '(?:table|thead|tfoot|caption|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|form|map|area|blockquote|address|math|style|input|p|h[1-6]|hr)';
+       $allblocks = '(?:code|table|thead|tfoot|caption|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|form|map|area|blockquote|address|math|style|input|p|h[1-6]|hr)';
        $pee = preg_replace('!(&lt;' . $allblocks . '[^&gt;]*&gt;)!', &quot;\n$1&quot;, $pee);
        $pee = preg_replace('!(&lt;/' . $allblocks . '&gt;)!', &quot;$1\n\n&quot;, $pee);
        $pee = str_replace(array(&quot;\r\n&quot;, &quot;\r&quot;), &quot;\n&quot;, $pee); // cross-platform newlines
@@ -80,6 +80,13 @@
        if (strpos($pee, '&lt;pre') !== false)
                $pee = preg_replace('!(&lt;pre.*?&gt;)(.*?)&lt;/pre&gt;!ise', &quot; stripslashes('$1') .  stripslashes(clean_pre('$2'))  . '&lt;/pre&gt;' &quot;, $pee);
        $pee = preg_replace( &quot;|\n&lt;/p&gt;$|&quot;, '&lt;/p&gt;', $pee );
+        $pee = preg_replace('| {4}|', str_repeat('&amp;amp;nbsp;',4), $pee);
+        $pee = str_replace('\\', '\\\\', $pee);
+        $pee = preg_replace(
+            '|&lt;code&gt;.*?&lt;/code&gt;|se'
+            , &quot;str_replace(array('&lt;p&gt;', '&lt;/p&gt;'), array('', '&lt;br /&gt;&lt;br /&gt;'), '$0')&quot;
+            , $pee);
+        $pee = StripSlashes($pee);

        return $pee;
 }
```
